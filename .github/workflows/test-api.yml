name: Tests API Backend - OptimisÃ©

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/test-api.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: 'Timeout pour l initialisation (minutes)'
        required: false
        default: '5'

env:
  COMPOSE_FILE: ./backend/docker compose.yml
  API_URL: http://localhost:8000
  INIT_TIMEOUT: ${{ github.event.inputs.timeout_minutes || '5' }}

jobs:
  test-api:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Timeout global du job
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ Configuration de Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install requests
        echo "âœ… DÃ©pendances installÃ©es"

    - name: ğŸ“ Configuration de l'environnement
      working-directory: ./backend
      run: |
        cat > .env << 'EOF'
        # Configuration pour tests CI/CD
        DB_USER=library_user
        DB_PASSWORD=secure_test_password_2024
        DB_DATABASE=library_db
        DB_ROOT_PASSWORD=root_secure_test_2024
        SECRET_KEY=github-actions-secret-key-for-jwt-tokens-min-32-characters-long
        EOF
        echo "âœ… Fichier .env crÃ©Ã©"
    
    - name: ğŸ—‚ï¸ VÃ©rification de la structure
      run: |
        echo "ğŸ“ Structure du projet:"
        ls -la backend/
        echo ""
        echo "ğŸ“„ Fichiers Python de test:"
        ls -la backend/*.py 2>/dev/null || echo "Aucun fichier .py trouvÃ© dans backend/"
    
    - name: ğŸ³ Construction et dÃ©marrage des conteneurs
      working-directory: ./backend
      run: |
        echo "ğŸ—ï¸ Construction des images..."
        docker compose build --no-cache
        
        echo "ğŸš€ DÃ©marrage des conteneurs en arriÃ¨re-plan..."
        docker compose up -d
        
        echo "ğŸ“Š Ã‰tat des conteneurs:"
        docker compose ps
    
    - name: â³ Attendre MySQL avec healthcheck
      timeout-minutes: ${{ fromJson(env.INIT_TIMEOUT) }}
      run: |
        echo "â³ Attente de MySQL (timeout: ${INIT_TIMEOUT} min)..."
        
        # Fonction de vÃ©rification MySQL
        check_mysql() {
          docker exec $(docker ps -qf "name=db") \
            mysqladmin ping -h localhost -u root -proot_secure_test_2024 --silent 2>/dev/null
        }
        
        # Boucle d'attente avec timeout
        max_attempts=$((${INIT_TIMEOUT} * 12))  # 5 secondes par tentative
        attempt=0
        
        while [ $attempt -lt $max_attempts ]; do
          if check_mysql; then
            elapsed=$((attempt * 5))
            echo "âœ… MySQL est opÃ©rationnel (${elapsed}s)"
            
            # Attendre encore 10s pour la stabilisation
            echo "â³ Stabilisation..."
            sleep 10
            exit 0
          fi
          
          attempt=$((attempt + 1))
          progress=$((attempt * 100 / max_attempts))
          echo "â³ Tentative ${attempt}/${max_attempts} (${progress}%)..."
          sleep 5
        done
        
        echo "âŒ MySQL n'a pas dÃ©marrÃ© Ã  temps"
        docker compose -f ./backend/docker compose.yml logs db
        exit 1
    
    - name: â³ Attendre l'API Backend
      timeout-minutes: ${{ fromJson(env.INIT_TIMEOUT) }}
      run: |
        echo "â³ Attente de l'API Backend..."
        
        # Fonction de vÃ©rification API
        check_api() {
          response=$(curl -s -o /dev/null -w "%{http_code}" ${API_URL}/ 2>/dev/null)
          [ "$response" = "200" ]
        }
        
        max_attempts=$((${INIT_TIMEOUT} * 12))
        attempt=0
        
        while [ $attempt -lt $max_attempts ]; do
          if check_api; then
            elapsed=$((attempt * 5))
            echo "âœ… API est opÃ©rationnelle (${elapsed}s)"
            exit 0
          fi
          
          attempt=$((attempt + 1))
          progress=$((attempt * 100 / max_attempts))
          echo "â³ Tentative ${attempt}/${max_attempts} (${progress}%)..."
          sleep 5
        done
        
        echo "âŒ API n'a pas dÃ©marrÃ© Ã  temps"
        docker compose -f ./backend/docker compose.yml logs backend
        exit 1
    
    - name: ğŸ” Validation de l'API
      run: |
        echo "ğŸ” VÃ©rification des endpoints critiques..."
        
        # Test root endpoint
        echo "Test: GET /"
        response=$(curl -s ${API_URL}/)
        echo "Response: $response"
        
        if ! echo "$response" | grep -q "Library API"; then
          echo "âŒ RÃ©ponse inattendue du root endpoint"
          exit 1
        fi
        echo "âœ… Root endpoint OK"
        
        # Test docs endpoint
        echo ""
        echo "Test: GET /docs"
        http_code=$(curl -s -o /dev/null -w "%{http_code}" ${API_URL}/docs)
        if [ "$http_code" != "200" ]; then
          echo "âŒ Documentation Swagger inaccessible (HTTP $http_code)"
          exit 1
        fi
        echo "âœ… Documentation Swagger accessible"
        
        # Test register endpoint
        echo ""
        echo "Test: POST /register"
        http_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST ${API_URL}/register \
          -H "Content-Type: application/json" \
          -d '{"nom":"Test","prenom":"API","email":"invalid"}')
        if [ "$http_code" != "422" ]; then
          echo "âš ï¸ Validation endpoint inattendue (HTTP $http_code)"
        else
          echo "âœ… Validation endpoint fonctionne"
        fi
    
    - name: ğŸ§ª Tests Backend (Plan Excel + RBAC)
      id: test-backend
      run: |
        echo "================================================"
        echo "    TESTS BACKEND - Plan Excel + RBAC"
        echo "================================================"
        python backend/test_backend.py
    
    - name: ğŸ“¬ Tests Notifications
      id: test-notifications
      run: |
        echo "================================================"
        echo "    TESTS NOTIFICATIONS"
        echo "================================================"
        python backend/test_notifications.py
    
    - name: ğŸ“Š Afficher les logs en cas d'Ã©chec
      if: failure()
      working-directory: ./backend
      run: |
        echo "================================================"
        echo "           LOGS DES CONTENEURS"
        echo "================================================"
        echo ""
        echo "=== BACKEND ==="
        docker compose logs --tail=100 backend
        echo ""
        echo "=== DATABASE ==="
        docker compose logs --tail=100 db
        echo ""
        echo "=== DOCKER PS ==="
        docker compose ps
    
    - name: ğŸ“ˆ GÃ©nÃ©ration du rapport de test
      if: always()
      run: |
        echo "# ğŸ“Š Rapport des Tests API" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## RÃ©sultats" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.test-backend.outcome }}" == "success" ]; then
          echo "- âœ… **Tests Backend**: SUCCÃˆS" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Tests Backend**: Ã‰CHEC" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.test-notifications.outcome }}" == "success" ]; then
          echo "- âœ… **Tests Notifications**: SUCCÃˆS" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Tests Notifications**: Ã‰CHEC" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Informations" >> $GITHUB_STEP_SUMMARY
        echo "- **Branche**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner**: \`${{ runner.os }}\`" >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ§¹ Nettoyage
      if: always()
      working-directory: ./backend
      run: |
        echo "ğŸ§¹ ArrÃªt et suppression des conteneurs..."
        docker compose down -v --remove-orphans
        
        echo "ğŸ—‘ï¸ Suppression des images de build..."
        docker system prune -f
        
        echo "âœ… Nettoyage terminÃ©"
    
    - name: âœ… Validation finale
      if: always()
      run: |
        echo "================================================"
        echo "           RÃ‰SULTAT FINAL"
        echo "================================================"
        
        backend_status="${{ steps.test-backend.outcome }}"
        notif_status="${{ steps.test-notifications.outcome }}"
        
        if [ "$backend_status" == "success" ] && [ "$notif_status" == "success" ]; then
          echo "ğŸ‰ TOUS LES TESTS SONT PASSÃ‰S AVEC SUCCÃˆS !"
          exit 0
        else
          echo "âŒ CERTAINS TESTS ONT Ã‰CHOUÃ‰"
          echo "   - Backend: $backend_status"
          echo "   - Notifications: $notif_status"
          exit 1
        fi